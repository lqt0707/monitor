name: Build and Publish SDK

on:
  push:
    branches: [main, master]
    paths:
      - "sdk/**"
      - ".github/workflows/build-and-publish.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "sdk/**"
      - ".github/workflows/build-and-publish.yml"
  release:
    types: [published]
  # 添加手动触发，用于测试
  workflow_dispatch:

jobs:
  # 版本检测和构建测试
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: sdk/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./sdk

      - name: Build all modules
        run: npm run build
        working-directory: ./sdk
        env:
          NODE_ENV: production

      - name: Verify build artifacts
        run: |
          # 检查所有模块的构建产物
          echo "🔍 检查构建产物..."

          # 检查core模块
          if [ ! -f "core/dist/index.js" ]; then
            echo "❌ core模块构建失败"
            exit 1
          fi

          # 检查web模块
          if [ ! -f "web-core/dist/index.js" ]; then
            echo "❌ web模块构建失败"
            exit 1
          fi

          # 检查taro模块
          if [ ! -f "taro-core/dist/index.js" ]; then
            echo "❌ taro模块构建失败"
            exit 1
          fi

          # 检查main模块
          if [ ! -f "dist/index.js" ]; then
            echo "❌ main模块构建失败"
            exit 1
          fi

          echo "✅ 所有模块构建成功"
          ls -la */dist/ | grep -E "(core|web-core|taro-core|main)"
        working-directory: ./sdk

      - name: Run tests
        run: npm test
        working-directory: ./sdk

  # 版本检测和发布准备
  check-version-and-prepare:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      should-publish: ${{ steps.version-check.outputs.should-publish }}
      new-version: ${{ steps.version-check.outputs.new-version }}
      previous-version: ${{ steps.version-check.outputs.previous-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Check version changes
        id: version-check
        run: |
          echo "🔍 检查版本变化..."

          # 获取当前版本
          CURRENT_VERSION=$(node -p "require('./sdk/package.json').version")
          echo "当前版本: $CURRENT_VERSION"

          # 获取上一次提交的版本
          PREVIOUS_VERSION=$(git show HEAD~1:./sdk/package.json | node -p "require('fs').readFileSync(0, 'utf8')" | node -p "require('fs').readFileSync(0, 'utf8')" | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8')).version" 2>/dev/null || echo "0.0.0")
          echo "上一次版本: $PREVIOUS_VERSION"

          # 检查版本是否发生变化
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "✅ 检测到版本变化: $PREVIOUS_VERSION -> $CURRENT_VERSION"
            echo "should-publish=true" >> $GITHUB_OUTPUT
            echo "new-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "previous-version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ 版本未发生变化，跳过发布"
            echo "should-publish=false" >> $GITHUB_OUTPUT
            echo "new-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "previous-version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.version-check.outputs.should-publish == 'true'
        run: |
          echo "🚀 创建GitHub Release..."

          # 获取版本信息
          NEW_VERSION="${{ steps.version-check.outputs.new-version }}"
          PREVIOUS_VERSION="${{ steps.version-check.outputs.previous-version }}"

          # 生成发布说明
          RELEASE_NOTES="## 🎉 版本 $NEW_VERSION 发布

          ### 📦 主要更新
          - 版本从 $PREVIOUS_VERSION 升级到 $NEW_VERSION

          ### 🔧 技术改进
          - 构建优化和性能提升
          - 类型定义完善
          - 文档更新

          ### 📋 安装方式
          \`\`\`bash
          # 完整功能包
          npm install @error-monitor/sdk

          # Web专用包
          npm install @error-monitor/web-sdk

          # Taro专用包
          npm install @error-monitor/taro-sdk

          # 核心包
          npm install @error-monitor/core
          \`\`\`

          ### 🔗 相关链接
          - [文档](https://github.com/${{ github.repository }}/tree/main/sdk)
          - [变更日志](https://github.com/${{ github.repository }}/blob/main/sdk/CHANGELOG.md)
          - [问题反馈](https://github.com/${{ github.repository }}/issues)"

          # 创建GitHub Release
          gh release create "v$NEW_VERSION" \
            --title "🎉 Monitor SDK v$NEW_VERSION" \
            --notes "$RELEASE_NOTES" \
            --target main \
            --latest

          echo "✅ GitHub Release 创建成功"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 自动发布到npm
  publish-npm:
    runs-on: ubuntu-latest
    needs: [build-and-test, check-version-and-prepare]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.check-version-and-prepare.outputs.should-publish == 'true') ||
      (github.event_name == 'release' && github.event.action == 'published')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"
          cache-dependency-path: sdk/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./sdk

      - name: Build for production
        run: npm run build:prod
        working-directory: ./sdk
        env:
          NODE_ENV: production

      - name: Publish main package to npm
        run: npm publish
        working-directory: ./sdk
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish core module to npm
        run: npm publish
        working-directory: ./sdk/core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish web-sdk to npm
        run: npm publish
        working-directory: ./sdk/web-core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish taro-sdk to npm
        run: npm publish
        working-directory: ./sdk/taro-core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Notify success
        run: |
          echo "🎉 所有包发布成功！"
          echo "版本: ${{ needs.check-version-and-prepare.outputs.new-version || 'latest' }}"
          echo "主包: @error-monitor/sdk"
          echo "核心包: @error-monitor/core"
          echo "Web包: @error-monitor/web-sdk"
          echo "Taro包: @error-monitor/taro-sdk"

  # 发布后处理
  post-publish:
    runs-on: ubuntu-latest
    needs: [publish-npm]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Update CHANGELOG
        if: needs.publish-npm.result == 'success'
        run: |
          echo "📝 更新变更日志..."

          # 获取版本信息
          NEW_VERSION="${{ needs.check-version-and-prepare.outputs.new-version || 'latest' }}"
          DATE=$(date +"%Y-%m-%d")

          # 创建变更日志条目
          CHANGELOG_ENTRY="## [$NEW_VERSION] - $DATE

          ### 🚀 新功能
          - 自动发布流程优化
          - GitHub Actions集成

          ### 🔧 改进
          - 构建流程优化
          - 测试覆盖率提升

          ### 🐛 修复
          - 修复构建脚本问题
          - 优化依赖管理

          ---
          "

          # 在CHANGELOG.md开头插入新条目
          if [ -f "./sdk/CHANGELOG.md" ]; then
            echo "$CHANGELOG_ENTRY" > temp_changelog.md
            cat "./sdk/CHANGELOG.md" >> temp_changelog.md
            mv temp_changelog.md "./sdk/CHANGELOG.md"
          else
            echo "$CHANGELOG_ENTRY" > "./sdk/CHANGELOG.md"
          fi

          # 提交变更
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "./sdk/CHANGELOG.md"
          git commit -m "📝 更新变更日志 v$NEW_VERSION" || echo "没有变更需要提交"
          git push || echo "推送失败，可能需要手动处理"

      - name: Notify completion
        run: |
          if [ "${{ needs.publish-npm.result }}" == "success" ]; then
            echo "🎉 发布流程完成！"
            echo "版本: ${{ needs.check-version-and-prepare.outputs.new-version || 'latest' }}"
            echo "所有包已成功发布到npm"
          else
            echo "❌ 发布流程失败"
            echo "请检查错误日志并手动处理"
          fi

  # 部署文档
  deploy-docs:
    runs-on: ubuntu-latest
    needs: [publish-npm]
    if: needs.publish-npm.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Generate documentation
        run: |
          npm ci
          npm run build
          # 这里可以添加文档生成命令
        working-directory: ./sdk

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./sdk/docs
