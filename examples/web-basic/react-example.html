<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web监控SDK - React集成示例</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .react-app {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    button {
      background: #61dafb;
      color: #282c34;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #21a9c7;
      color: white;
    }

    .error {
      background: #ff4444;
      color: white;
    }

    .error:hover {
      background: #cc0000;
    }

    .status {
      background: #e8f5e8;
      border: 1px solid #4caf50;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }

    .log {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .form-group {
      margin: 10px 0;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .counter {
      background: white;
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }

    .counter h3 {
      margin: 0 0 10px 0;
      color: #282c34;
    }

    .counter .count {
      font-size: 2em;
      font-weight: bold;
      color: #61dafb;
      margin: 10px 0;
    }

    .user-form {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin: 10px 0;
    }

    .user-list {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin: 10px 0;
    }

    .user-item {
      padding: 10px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #61dafb;
    }
  </style>
</head>

<body>
  <h1>Web监控SDK - React集成示例</h1>

  <div class="container">
    <h2>SDK状态</h2>
    <div id="status" class="status">正在初始化...</div>
  </div>

  <!-- React应用容器 -->
  <div id="root" class="react-app"></div>

  <div class="container">
    <h2>控制台日志</h2>
    <div id="logs" class="log"></div>
    <button onclick="clearLogs()">清空日志</button>
  </div>

  <!-- 引入React和ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- 引入Babel用于JSX转换 -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 引入SDK -->
  <script src="../dist/index.umd.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;
    const monitor = window.MonitorSDK;

    // 日志记录函数
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logElement = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.style.color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
      logEntry.textContent = `[${timestamp}] ${message}`;
      logElement.appendChild(logEntry);
      logElement.scrollTop = logElement.scrollHeight;
      console[type](message);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      log('日志已清空');
    }

    // 初始化SDK
    monitor.init({
      projectId: 'react-demo-project',
      serverUrl: 'http://localhost:3001/api/monitor',
      enableErrorMonitor: true,
      enablePerformanceMonitor: true,
      enableBehaviorMonitor: true,
      enableInDev: true,
      sampleRate: 1,
      maxErrors: 50,
      reportInterval: 3000,
      userId: 'react-demo-user-123',
      tags: {
        framework: 'react',
        version: '18.0',
        environment: 'demo'
      }
    });

    // 错误边界组件
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        log(`React错误边界捕获: ${error.message}`, 'error');
        monitor.captureError('React组件错误', {
          error: error.message,
          stack: error.stack,
          componentStack: errorInfo.componentStack,
          component: this.props.name || 'Unknown'
        });
      }

      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: '20px', background: '#ffebee', border: '1px solid #f44336', borderRadius: '4px' }}>
              <h3>组件发生错误</h3>
              <p>错误信息: {this.state.error?.message}</p>
              <button onClick={() => this.setState({ hasError: false, error: null })}>
                重置组件
              </button>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // 计数器组件
    function Counter() {
      const [count, setCount] = useState(0);
      const [step, setStep] = useState(1);

      const increment = useCallback(() => {
        setCount(prev => {
          const newCount = prev + step;
          monitor.trackBehavior('counter_increment', {
            oldValue: prev,
            newValue: newCount,
            step
          });
          log(`计数器增加: ${prev} -> ${newCount}`);
          return newCount;
        });
      }, [step]);

      const decrement = useCallback(() => {
        setCount(prev => {
          const newCount = prev - step;
          monitor.trackBehavior('counter_decrement', {
            oldValue: prev,
            newValue: newCount,
            step
          });
          log(`计数器减少: ${prev} -> ${newCount}`);
          return newCount;
        });
      }, [step]);

      const reset = useCallback(() => {
        setCount(0);
        monitor.trackBehavior('counter_reset', { previousValue: count });
        log('计数器重置');
      }, [count]);

      return (
        <div className="counter">
          <h3>React计数器</h3>
          <div className="count">{count}</div>
          <div className="form-group">
            <label>步长:</label>
            <input
              type="number"
              value={step}
              onChange={(e) => setStep(parseInt(e.target.value) || 1)}
            />
          </div>
          <button onClick={increment}>增加 (+{step})</button>
          <button onClick={decrement}>减少 (-{step})</button>
          <button onClick={reset}>重置</button>
        </div>
      );
    }

    // 用户管理组件
    function UserManager() {
      const [users, setUsers] = useState([
        { id: 1, name: '张三', email: 'zhangsan@example.com', age: 25 },
        { id: 2, name: '李四', email: 'lisi@example.com', age: 30 }
      ]);
      const [formData, setFormData] = useState({ name: '', email: '', age: '' });
      const [loading, setLoading] = useState(false);

      const addUser = useCallback(async () => {
        if (!formData.name || !formData.email) {
          monitor.captureError('表单验证失败', {
            formData,
            missingFields: [!formData.name && 'name', !formData.email && 'email'].filter(Boolean)
          });
          log('请填写完整的用户信息', 'error');
          return;
        }

        setLoading(true);
        const start = performance.now();

        try {
          // 模拟API调用
          await new Promise(resolve => setTimeout(resolve, 1000));

          const newUser = {
            id: Date.now(),
            name: formData.name,
            email: formData.email,
            age: parseInt(formData.age) || 0
          };

          setUsers(prev => [...prev, newUser]);
          setFormData({ name: '', email: '', age: '' });

          const duration = performance.now() - start;
          monitor.trackBehavior('user_added', {
            user: newUser,
            duration,
            totalUsers: users.length + 1
          });
          log(`用户添加成功: ${newUser.name}, 耗时: ${duration.toFixed(2)}ms`);
        } catch (error) {
          monitor.captureError('添加用户失败', {
            error: error.message,
            formData
          });
          log(`添加用户失败: ${error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [formData, users.length]);

      const deleteUser = useCallback((id) => {
        const user = users.find(u => u.id === id);
        if (user) {
          setUsers(prev => prev.filter(u => u.id !== id));
          monitor.trackBehavior('user_deleted', {
            user,
            remainingUsers: users.length - 1
          });
          log(`用户删除: ${user.name}`);
        }
      }, [users]);

      const handleInputChange = useCallback((field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
        monitor.trackBehavior('form_input', {
          field,
          value: value.length,
          component: 'UserManager'
        });
      }, []);

      return (
        <div>
          <div className="user-form">
            <h3>添加用户</h3>
            <div className="form-group">
              <label>姓名:</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => handleInputChange('name', e.target.value)}
                placeholder="请输入姓名"
              />
            </div>
            <div className="form-group">
              <label>邮箱:</label>
              <input
                type="email"
                value={formData.email}
                onChange={(e) => handleInputChange('email', e.target.value)}
                placeholder="请输入邮箱"
              />
            </div>
            <div className="form-group">
              <label>年龄:</label>
              <input
                type="number"
                value={formData.age}
                onChange={(e) => handleInputChange('age', e.target.value)}
                placeholder="请输入年龄"
              />
            </div>
            <button onClick={addUser} disabled={loading}>
              {loading ? '添加中...' : '添加用户'}
            </button>
          </div>

          <div className="user-list">
            <h3>用户列表 ({users.length} 人)</h3>
            {users.map(user => (
              <div key={user.id} className="user-item">
                <strong>{user.name}</strong> - {user.email} - {user.age}岁
                <button
                  onClick={() => deleteUser(user.id)}
                  className="error"
                  style={{ float: 'right' }}
                >
                  删除
                </button>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // 错误测试组件
    function ErrorTestComponent() {
      const [shouldThrow, setShouldThrow] = useState(false);
      const renderCount = useRef(0);

      useEffect(() => {
        renderCount.current++;
        if (shouldThrow) {
          throw new Error('React组件渲染错误测试');
        }
      }, [shouldThrow]);

      const triggerRenderError = () => {
        log('触发React渲染错误', 'warn');
        setShouldThrow(true);
      };

      const triggerAsyncError = () => {
        log('触发React异步错误', 'warn');
        setTimeout(() => {
          throw new Error('React组件中的异步错误');
        }, 100);
      };

      const triggerPromiseError = () => {
        log('触发React Promise错误', 'warn');
        Promise.reject(new Error('React组件中的Promise错误'));
      };

      const triggerCustomError = () => {
        log('触发React自定义错误', 'warn');
        monitor.captureError('React自定义错误', {
          component: 'ErrorTestComponent',
          renderCount: renderCount.current,
          timestamp: Date.now()
        });
      };

      return (
        <div className="container">
          <h3>React错误测试</h3>
          <p>渲染次数: {renderCount.current}</p>
          <button onClick={triggerRenderError} className="error">触发渲染错误</button>
          <button onClick={triggerAsyncError} className="error">触发异步错误</button>
          <button onClick={triggerPromiseError} className="error">触发Promise错误</button>
          <button onClick={triggerCustomError} className="error">触发自定义错误</button>
        </div>
      );
    }

    // 性能测试组件
    function PerformanceTestComponent() {
      const [items, setItems] = useState([]);
      const [isProcessing, setIsProcessing] = useState(false);

      const generateLargeList = useCallback(() => {
        log('生成大列表', 'warn');
        setIsProcessing(true);
        const start = performance.now();

        setTimeout(() => {
          const newItems = Array.from({ length: 1000 }, (_, i) => ({
            id: i,
            name: `Item ${i}`,
            value: Math.random() * 1000
          }));

          setItems(newItems);
          setIsProcessing(false);

          const duration = performance.now() - start;
          monitor.trackBehavior('large_list_generated', {
            itemCount: newItems.length,
            duration
          });
          log(`大列表生成完成，耗时: ${duration.toFixed(2)}ms`);
        }, 10);
      }, []);

      const performHeavyCalculation = useCallback(() => {
        log('执行重计算', 'warn');
        const start = performance.now();

        let result = 0;
        for (let i = 0; i < 1000000; i++) {
          result += Math.sqrt(i) * Math.sin(i);
        }

        const duration = performance.now() - start;
        monitor.trackBehavior('heavy_calculation', {
          duration,
          result: result.toFixed(2)
        });
        log(`重计算完成，结果: ${result.toFixed(2)}, 耗时: ${duration.toFixed(2)}ms`);
      }, []);

      const clearItems = useCallback(() => {
        setItems([]);
        monitor.trackBehavior('items_cleared', { previousCount: items.length });
        log('列表已清空');
      }, [items.length]);

      return (
        <div className="container">
          <h3>React性能测试</h3>
          <p>当前列表项数: {items.length}</p>
          <button onClick={generateLargeList} disabled={isProcessing}>
            {isProcessing ? '生成中...' : '生成1000项列表'}
          </button>
          <button onClick={performHeavyCalculation}>执行重计算</button>
          <button onClick={clearItems}>清空列表</button>

          {items.length > 0 && (
            <div style={{ maxHeight: '200px', overflow: 'auto', marginTop: '10px' }}>
              {items.slice(0, 50).map(item => (
                <div key={item.id} style={{ padding: '2px', fontSize: '12px' }}>
                  {item.name}: {item.value.toFixed(2)}
                </div>
              ))}
              {items.length > 50 && <div>... 还有 {items.length - 50} 项</div>}
            </div>
          )}
        </div>
      );
    }

    // 主应用组件
    function App() {
      const [currentTab, setCurrentTab] = useState('counter');

      useEffect(() => {
        log('React应用已挂载');
        monitor.trackPageView({
          title: 'React Demo应用',
          url: location.href
        });
        updateStatus();
      }, []);

      const switchTab = useCallback((tab) => {
        setCurrentTab(tab);
        monitor.trackBehavior('tab_switched', {
          from: currentTab,
          to: tab
        });
        log(`切换标签: ${currentTab} -> ${tab}`);
      }, [currentTab]);

      const updateStatus = () => {
        const status = monitor.getStatus();
        const statusElement = document.getElementById('status');
        statusElement.innerHTML = `
          <strong>React应用状态:</strong> 已挂载<br>
          <strong>SDK初始化:</strong> ${status.isInitialized ? '已初始化' : '未初始化'}<br>
          <strong>会话ID:</strong> ${status.sessionId}<br>
          <strong>错误数量:</strong> ${status.errorCount}<br>
          <strong>性能数据:</strong> ${status.performanceCount}<br>
          <strong>行为数据:</strong> ${status.behaviorCount}
        `;
      };

      return (
        <div>
          <h2>React Demo应用</h2>

          {/* 标签导航 */}
          <div style={{ marginBottom: '20px' }}>
            <button
              onClick={() => switchTab('counter')}
              style={{ background: currentTab === 'counter' ? '#21a9c7' : '#61dafb' }}
            >
              计数器
            </button>
            <button
              onClick={() => switchTab('users')}
              style={{ background: currentTab === 'users' ? '#21a9c7' : '#61dafb' }}
            >
              用户管理
            </button>
            <button
              onClick={() => switchTab('errors')}
              style={{ background: currentTab === 'errors' ? '#21a9c7' : '#61dafb' }}
            >
              错误测试
            </button>
            <button
              onClick={() => switchTab('performance')}
              style={{ background: currentTab === 'performance' ? '#21a9c7' : '#61dafb' }}
            >
              性能测试
            </button>
          </div>

          {/* 标签内容 */}
          <ErrorBoundary name={`${currentTab}Tab`}>
            {currentTab === 'counter' && <Counter />}
            {currentTab === 'users' && <UserManager />}
            {currentTab === 'errors' && <ErrorTestComponent />}
            {currentTab === 'performance' && <PerformanceTestComponent />}
          </ErrorBoundary>

          {/* 通用操作 */}
          <div className="container">
            <h3>SDK操作</h3>
            <button onClick={updateStatus}>更新状态</button>
            <button onClick={() => monitor.flush()}>立即上报数据</button>
            <button onClick={() => {
              monitor.trackBehavior('manual_track', {
                component: 'App',
                currentTab,
                timestamp: Date.now()
              });
              log('手动跟踪行为');
            }}>手动跟踪行为</button>
          </div>
        </div>
      );
    }

    // 渲染应用
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    // 监听SDK事件
    window.addEventListener('monitor:error', (event) => {
      log('SDK捕获错误: ' + event.detail.message, 'error');
    });

    window.addEventListener('monitor:performance', (event) => {
      log('SDK性能数据: ' + event.detail.type, 'info');
    });

    window.addEventListener('monitor:behavior', (event) => {
      log('SDK行为数据: ' + event.detail.event, 'info');
    });

    // 页面卸载时清理
    window.addEventListener('beforeunload', () => {
      monitor.flush();
      log('页面卸载，数据已上报');
    });

    log('React集成示例已加载');
  </script>
</body>

</html>