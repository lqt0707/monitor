<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coreæ¶æ„ - Monitor SDK ç¤ºä¾‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .status-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .status-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .status-label {
            color: #64748b;
            margin-top: 5px;
        }

        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .test-section h3 {
            margin: 0 0 15px 0;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-success {
            background: #059669;
        }

        .btn-success:hover {
            background: #047857;
        }

        .logs {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-timestamp {
            color: #64748b;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #f87171;
        }

        .log-warning {
            color: #fbbf24;
        }

        .log-info {
            color: #60a5fa;
        }

        .architecture-info {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .architecture-info h4 {
            color: #047857;
            margin: 0 0 10px 0;
        }

        .architecture-info ul {
            color: #065f46;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ”¥ Coreæ¶æ„ Monitor SDK</h1>
        <p>åŸºäºå…¨æ–°Coreæ¶æ„çš„Webç›‘æ§SDKæ¼”ç¤º</p>
    </div>

    <div class="architecture-info">
        <h4>ğŸ—ï¸ Coreæ¶æ„ä¼˜åŠ¿</h4>
        <ul>
            <li><strong>ä»£ç å¤ç”¨ç‡æå‡80%</strong> - æ ¸å¿ƒé€»è¾‘ç»Ÿä¸€å®ç°</li>
            <li><strong>APIå®Œå…¨ä¸€è‡´</strong> - æ‰€æœ‰å¹³å°ä½¿ç”¨ç›¸åŒæ¥å£</li>
            <li><strong>ç»´æŠ¤æˆæœ¬é™ä½</strong> - ä¸€å¤„ä¿®æ”¹å…¨å¹³å°ç”Ÿæ•ˆ</li>
            <li><strong>æ‰©å±•æ€§æå¼º</strong> - æ–°å¹³å°åªéœ€å®ç°é€‚é…å™¨</li>
        </ul>
    </div>

    <div class="status-panel">
        <h3>ğŸ“Š SDKè¿è¡ŒçŠ¶æ€</h3>
        <div id="sdk-status">åˆå§‹åŒ–ä¸­...</div>
        <div class="status-grid">
            <div class="status-item">
                <div class="status-value" id="error-count">0</div>
                <div class="status-label">é”™è¯¯æ•°é‡</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="performance-count">0</div>
                <div class="status-label">æ€§èƒ½æ•°æ®</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="behavior-count">0</div>
                <div class="status-label">è¡Œä¸ºæ•°æ®</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="queue-size">0</div>
                <div class="status-label">é˜Ÿåˆ—å¤§å°</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸš¨ é”™è¯¯ç›‘æ§æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="btn btn-danger" onclick="triggerJSError()">JavaScripté”™è¯¯</button>
            <button class="btn btn-danger" onclick="triggerPromiseError()">Promiseå¼‚å¸¸</button>
            <button class="btn btn-danger" onclick="triggerResourceError()">èµ„æºåŠ è½½é”™è¯¯</button>
            <button class="btn btn-danger" onclick="triggerCustomError()">è‡ªå®šä¹‰é”™è¯¯</button>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ˆ æ€§èƒ½ç›‘æ§æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="btn" onclick="recordPagePerformance()">é¡µé¢æ€§èƒ½</button>
            <button class="btn" onclick="recordAPIPerformance()">APIæ€§èƒ½</button>
            <button class="btn" onclick="recordCustomMetric()">è‡ªå®šä¹‰æŒ‡æ ‡</button>
            <button class="btn" onclick="recordResourceTiming()">èµ„æºæ—¶é—´</button>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ‘† è¡Œä¸ºç›‘æ§æµ‹è¯•</h3>
        <div class="test-buttons">
            <button class="btn btn-secondary" onclick="recordClick()">ç‚¹å‡»äº‹ä»¶</button>
            <button class="btn btn-secondary" onclick="recordPageView()">é¡µé¢è®¿é—®</button>
            <button class="btn btn-secondary" onclick="recordFormSubmit()">è¡¨å•æäº¤</button>
            <button class="btn btn-secondary" onclick="recordCustomBehavior()">è‡ªå®šä¹‰è¡Œä¸º</button>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ”„ æ•°æ®ç®¡ç†</h3>
        <div class="test-buttons">
            <button class="btn btn-success" onclick="flushData()">ç«‹å³ä¸ŠæŠ¥</button>
            <button class="btn btn-secondary" onclick="getSDKStatus()">è·å–çŠ¶æ€</button>
            <button class="btn btn-secondary" onclick="clearQueue()">æ¸…ç©ºé˜Ÿåˆ—</button>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
        <div class="logs" id="logs"></div>
        <div style="margin-top: 15px;">
            <button class="btn btn-secondary" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <button class="btn btn-secondary" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        // Coreæ¶æ„SDKæ¨¡æ‹Ÿå®ç°
        class CoreWebMonitorSDK {
            constructor() {
                this.config = null;
                this.initialized = false;
                this.counters = {
                    errors: 0,
                    performance: 0,
                    behaviors: 0
                };
                this.queue = [];
                this.listeners = new Map();
                this.sessionId = this.generateSessionId();
            }

            init(config) {
                this.config = {
                    // é»˜è®¤é…ç½®
                    projectId: 'demo-project',
                    serverUrl: 'http://localhost:3001/api/monitor',
                    error: { enabled: true, maxErrors: 100 },
                    performance: { enabled: true, maxPerformance: 100 },
                    behavior: { enabled: true, maxBehaviors: 200 },
                    report: { interval: 10000, batchSize: 20 },
                    ...config
                };

                this.initialized = true;
                this.log('âœ… Coreæ¶æ„SDKåˆå§‹åŒ–æˆåŠŸ', 'success');
                this.log(`ğŸ“‹ é…ç½®: ${JSON.stringify(this.config, null, 2)}`, 'info');
                this.updateStatus();

                // è‡ªåŠ¨è®°å½•é¡µé¢è®¿é—®
                this.recordBehavior('page_view', {
                    title: document.title,
                    url: window.location.href,
                    timestamp: Date.now()
                });

                return this;
            }

            captureError(error, extra = {}) {
                if (!this.config?.error?.enabled) return;

                this.counters.errors++;
                const errorData = {
                    id: this.generateId(),
                    timestamp: Date.now(),
                    projectId: this.config.projectId,
                    sessionId: this.sessionId,
                    type: 'custom_error',
                    message: typeof error === 'string' ? error : error.message,
                    stack: error.stack,
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    ...extra
                };

                this.addToQueue(errorData);
                this.emit('error', errorData);
                this.log(`ğŸš¨ æ•è·é”™è¯¯: ${errorData.message}`, 'error');
                this.updateStatus();
            }

            recordPerformance(name, metrics) {
                if (!this.config?.performance?.enabled) return;

                this.counters.performance++;
                const perfData = {
                    id: this.generateId(),
                    timestamp: Date.now(),
                    projectId: this.config.projectId,
                    sessionId: this.sessionId,
                    type: 'custom_metric',
                    name,
                    metrics,
                    url: window.location.href
                };

                this.addToQueue(perfData);
                this.emit('performance', perfData);
                this.log(`ğŸ“Š æ€§èƒ½æŒ‡æ ‡: ${name} - ${JSON.stringify(metrics)}`, 'info');
                this.updateStatus();
            }

            recordBehavior(event, data = {}) {
                if (!this.config?.behavior?.enabled) return;

                this.counters.behaviors++;
                const behaviorData = {
                    id: this.generateId(),
                    timestamp: Date.now(),
                    projectId: this.config.projectId,
                    sessionId: this.sessionId,
                    type: 'custom',
                    event,
                    data,
                    url: window.location.href
                };

                this.addToQueue(behaviorData);
                this.emit('behavior', behaviorData);
                this.log(`ğŸ‘† è¡Œä¸ºäº‹ä»¶: ${event} - ${JSON.stringify(data)}`, 'info');
                this.updateStatus();
            }

            async flush() {
                if (this.queue.length === 0) {
                    this.log('â„¹ï¸ é˜Ÿåˆ—ä¸ºç©ºï¼Œæ— éœ€ä¸ŠæŠ¥', 'warning');
                    return;
                }

                const dataToSend = [...this.queue];
                this.queue = [];
                this.log(`ğŸ”„ ä¸ŠæŠ¥ ${dataToSend.length} æ¡æ•°æ®...`, 'info');

                // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
                try {
                    await this.simulateNetworkRequest(dataToSend);
                    this.log(`âœ… æ•°æ®ä¸ŠæŠ¥æˆåŠŸ`, 'success');
                } catch (error) {
                    this.log(`âŒ æ•°æ®ä¸ŠæŠ¥å¤±è´¥: ${error.message}`, 'error');
                    // å¤±è´¥æ—¶é‡æ–°æ”¾å›é˜Ÿåˆ—
                    this.queue.unshift(...dataToSend);
                }
                this.updateStatus();
            }

            getStatus() {
                return {
                    initialized: this.initialized,
                    counters: { ...this.counters },
                    queueSize: this.queue.length,
                    sessionId: this.sessionId,
                    config: this.config
                };
            }

            // ç§æœ‰æ–¹æ³•
            addToQueue(data) {
                this.queue.push(data);
                const maxSize = this.config?.report?.maxQueueSize || 500;
                if (this.queue.length > maxSize) {
                    this.queue.shift(); // ç§»é™¤æœ€æ—§çš„æ•°æ®
                }
            }

            simulateNetworkRequest(data) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 90%æˆåŠŸç‡
                        if (Math.random() > 0.1) {
                            resolve({ success: true, count: data.length });
                        } else {
                            reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥'));
                        }
                    }, 500 + Math.random() * 1000);
                });
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            generateSessionId() {
                return 'session_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logsDiv = document.getElementById('logs');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
                logsDiv.appendChild(logEntry);
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }

            updateStatus() {
                const status = this.getStatus();

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                document.getElementById('sdk-status').innerHTML =
                    status.initialized ? '<span style="color: #10b981;">âœ… å·²åˆå§‹åŒ–</span>' : '<span style="color: #dc2626;">âŒ æœªåˆå§‹åŒ–</span>';

                document.getElementById('error-count').textContent = status.counters.errors;
                document.getElementById('performance-count').textContent = status.counters.performance;
                document.getElementById('behavior-count').textContent = status.counters.behaviors;
                document.getElementById('queue-size').textContent = status.queueSize;
            }

            // äº‹ä»¶ç³»ç»Ÿ
            on(event, listener) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(listener);
            }

            emit(event, data) {
                const listeners = this.listeners.get(event) || [];
                listeners.forEach(listener => {
                    try {
                        listener(data);
                    } catch (error) {
                        console.error('Event listener error:', error);
                    }
                });
            }
        }

        // åˆ›å»ºå…¨å±€SDKå®ä¾‹
        const MonitorSDK = new CoreWebMonitorSDK();

        // åˆå§‹åŒ–SDK
        MonitorSDK.init({
            projectId: 'core-demo-project',
            serverUrl: 'http://localhost:3001/api/monitor',
            error: { enabled: true, maxErrors: 100 },
            performance: { enabled: true, maxPerformance: 100 },
            behavior: { enabled: true, maxBehaviors: 200 }
        });

        // ç›‘å¬äº‹ä»¶
        MonitorSDK.on('error', (data) => {
            console.log('Error captured:', data);
        });

        MonitorSDK.on('performance', (data) => {
            console.log('Performance recorded:', data);
        });

        MonitorSDK.on('behavior', (data) => {
            console.log('Behavior tracked:', data);
        });

        // æµ‹è¯•å‡½æ•°
        function triggerJSError() {
            try {
                // æ•…æ„è§¦å‘JavaScripté”™è¯¯
                nonExistentFunction();
            } catch (error) {
                MonitorSDK.captureError(error);
            }
        }

        function triggerPromiseError() {
            Promise.reject(new Error('Promiseå¼‚å¸¸æµ‹è¯•'))
                .catch(error => MonitorSDK.captureError(error));
        }

        function triggerResourceError() {
            const img = new Image();
            img.onerror = () => {
                MonitorSDK.captureError('èµ„æºåŠ è½½å¤±è´¥: nonexistent-image.jpg');
            };
            img.src = 'nonexistent-image.jpg';
        }

        function triggerCustomError() {
            MonitorSDK.captureError('è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯æµ‹è¯•', {
                level: 'warning',
                source: 'user_action',
                extra: { buttonId: 'custom-error-btn' }
            });
        }

        function recordPagePerformance() {
            const perfData = performance.getEntriesByType('navigation')[0];
            if (perfData) {
                MonitorSDK.recordPerformance('page_load', {
                    loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                    domReady: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                    firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime || 0
                });
            }
        }

        function recordAPIPerformance() {
            const startTime = performance.now();
            setTimeout(() => {
                const duration = performance.now() - startTime;
                MonitorSDK.recordPerformance('api_call', {
                    duration: Math.round(duration),
                    url: '/api/test',
                    method: 'GET',
                    status: 200
                });
            }, Math.random() * 200 + 50);
        }

        function recordCustomMetric() {
            MonitorSDK.recordPerformance('custom_operation', {
                duration: Math.round(Math.random() * 1000),
                memory: performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 0,
                timing: Date.now()
            });
        }

        function recordResourceTiming() {
            const resources = performance.getEntriesByType('resource').slice(-5);
            resources.forEach(resource => {
                MonitorSDK.recordPerformance('resource_load', {
                    name: resource.name.split('/').pop(),
                    duration: Math.round(resource.duration),
                    size: resource.transferSize || 0,
                    type: resource.initiatorType
                });
            });
        }

        function recordClick() {
            MonitorSDK.recordBehavior('click', {
                target: 'test-button',
                x: Math.round(Math.random() * 800),
                y: Math.round(Math.random() * 600),
                timestamp: Date.now()
            });
        }

        function recordPageView() {
            MonitorSDK.recordBehavior('page_view', {
                title: 'Test Page',
                url: '/test',
                referrer: document.referrer,
                viewport: `${window.innerWidth}x${window.innerHeight}`
            });
        }

        function recordFormSubmit() {
            MonitorSDK.recordBehavior('form_submit', {
                formId: 'test-form',
                fields: ['name', 'email'],
                success: true,
                duration: Math.round(Math.random() * 5000)
            });
        }

        function recordCustomBehavior() {
            MonitorSDK.recordBehavior('custom_action', {
                action: 'feature_usage',
                feature: 'core_demo',
                value: Math.round(Math.random() * 100),
                metadata: {
                    browser: navigator.userAgent.match(/Chrome|Firefox|Safari/)[0],
                    timestamp: Date.now()
                }
            });
        }

        function flushData() {
            MonitorSDK.flush();
        }

        function getSDKStatus() {
            const status = MonitorSDK.getStatus();
            MonitorSDK.log(`SDKçŠ¶æ€: ${JSON.stringify(status, null, 2)}`, 'info');
        }

        function clearQueue() {
            MonitorSDK.queue = [];
            MonitorSDK.updateStatus();
            MonitorSDK.log('âœ… é˜Ÿåˆ—å·²æ¸…ç©º', 'success');
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function exportLogs() {
            const logs = document.getElementById('logs').textContent;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monitor-logs-${new Date().getTime()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // è‡ªåŠ¨å®šæ—¶ä¸ŠæŠ¥
        setInterval(() => {
            if (MonitorSDK.queue.length > 0) {
                MonitorSDK.flush();
            }
        }, 15000);

        // é¡µé¢ç¦»å¼€æ—¶ä¸ŠæŠ¥
        window.addEventListener('beforeunload', () => {
            if (MonitorSDK.queue.length > 0) {
                navigator.sendBeacon('/api/monitor/report', JSON.stringify(MonitorSDK.queue));
            }
        });

        // æ˜¾ç¤ºåˆå§‹åŒ–å®Œæˆæ¶ˆæ¯
        setTimeout(() => {
            MonitorSDK.log('ğŸ‰ Coreæ¶æ„æ¼”ç¤ºé¡µé¢å‡†å¤‡å°±ç»ª', 'success');
            MonitorSDK.log('ğŸ’¡ ç‚¹å‡»æŒ‰é’®ä½“éªŒå„ç§ç›‘æ§åŠŸèƒ½', 'info');
        }, 1000);
    </script>
</body>

</html>