### SDK 系统架构设计总览

我来帮你整理 SDK 的整体架构设计，让你快速理解各个模块的职责和关系。

## 🏗️ 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    SDK 统一入口层                            │
│  index.js (自动环境检测 + 公共 API)                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    平台适配层 (Platform Adapters)           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Web 适配器  │  │ Taro 适配器 │  │ 其他平台    │        │
│  │WebPlatform  │  │TaroPlatform │  │ 适配器      │        │
│  │  Adapter    │  │  Adapter    │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    核心管理层 (Core Managers)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 基础管理器  │  │ 错误管理器  │  │ 其他管理器  │        │
│  │BaseManager  │  │ErrorManager │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    核心接口层 (Core Interfaces)            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 平台适配器  │  │ 数据类型    │  │ 工具函数    │        │
│  │ 接口定义    │  │ 定义        │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    构建与工具层 (Build & Tools)            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 构建配置    │  │ 源码打包    │  │ 自动化脚本  │        │
│  │ Rollup      │  │ Source      │  │ 配置工具    │        │
│  │ Configs     │  │ Packer      │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## �� 目录结构解析

```
sdk/
├── index.js                    # 🚪 统一入口，自动环境检测
├── core/                       # �� 核心模块
│   ├── index.ts               # 核心模块导出
│   ├── managers/              # 管理器实现
│   │   ├── BaseManager.ts     # 基础管理器（核心流程）
│   │   └── ErrorManager.ts    # 错误管理器（聚合/指纹）
│   ├── interfaces/            # 接口定义
│   │   └── PlatformAdapter.ts # 平台适配器契约
│   ├── types/                 # 类型定义
│   │   └── base.ts            # 基础数据类型
│   └── utils/                 # 工具函数
│       ├── common.ts          # 通用工具
│       ├── queue.ts           # 队列管理
│       └── version.ts         # 版本/源码映射工具
├── adapters/                  # 🔌 平台适配器实现
│   ├── web/                   # Web 平台适配
│   │   └── WebPlatformAdapter.ts
│   └── taro-mini/             # Taro 小程序适配
│       └── TaroPlatformAdapter.ts
├── web-core/                  # �� Web SDK 核心
│   └── index.ts               # Web SDK 实现
├── taro-core/                 # 📱 Taro SDK 核心
│   └── index.ts               # Taro SDK 实现
├── source-packer/             # �� 源码打包工具
├── scripts/                   # ��️ 构建和配置脚本
└── build.config.cjs           # ⚙️ 构建配置
```

## 🔄 核心数据流

### 1. 初始化流程

```
用户调用 Monitor.init(config)
    ↓
BaseManager.init()
    ↓
PlatformAdapter.init() → 初始化平台特定功能
    ↓
注册错误/性能/行为监听器
    ↓
启动定时上报定时器
    ↓
SDK 就绪，开始采集数据
```

### 2. 数据采集流程

```
浏览器/小程序事件触发
    ↓
PlatformAdapter 捕获（错误/性能/行为）
    ↓
构造标准化的 MonitorData
    ↓
BaseManager.addToQueue() → 入队并补充基础信息
    ↓
定时器触发 BaseManager.flush()
    ↓
批量发送到服务器
```

### 3. 错误处理特殊流程

```
错误发生
    ↓
ErrorManager.handleError()
    ↓
版本信息注入 + 堆栈解析
    ↓
生成错误指纹（去重）
    ↓
聚合统计（次数/影响用户）
    ↓
智能上报策略（首次/5次/10次/每50次）
    ↓
传给 BaseManager 入队
```

## �� 设计模式与原则

### 1. 适配器模式 (Adapter Pattern)

- **目的**：统一不同平台的监控接口
- **实现**：`PlatformAdapter` 接口 + Web/Taro 具体实现
- **好处**：新增平台只需实现接口，不影响核心逻辑

### 2. 策略模式 (Strategy Pattern)

- **目的**：不同平台使用不同的数据采集策略
- **实现**：Web 用 DOM API，Taro 用小程序 API
- **好处**：平台特性得到充分利用

### 3. 观察者模式 (Observer Pattern)

- **目的**：解耦数据采集和上报逻辑
- **实现**：EventEmitter + 回调函数
- **好处**：模块间松耦合，易于扩展

### 4. 工厂模式 (Factory Pattern)

- **目的**：根据环境自动选择合适的 SDK
- **实现**：`autoDetectSDK()` 函数
- **好处**：用户无需关心平台差异

## 🔧 关键接口设计

### PlatformAdapter 接口

```typescript
interface PlatformAdapter {
  readonly platformInfo: PlatformInfo; // 平台信息
  readonly errorCapture: ErrorCaptureAdapter; // 错误捕获
  readonly performance: PerformanceAdapter; // 性能监控
  readonly behavior: BehaviorAdapter; // 行为监控
  readonly network: NetworkAdapter; // 网络适配
  readonly storage: StorageAdapter; // 存储适配

  init(config: Record<string, any>): void; // 初始化
  destroy(): void; // 销毁
}
```

### 数据流转接口

```typescript
// 错误捕获回调
initErrorListeners(onError: (error: ErrorData) => void): void;

// 性能监控回调
initPerformanceMonitor(onPerformance: (data: PerformanceData) => void): void;

// 行为监控回调
initBehaviorMonitor(onBehavior: (data: BehaviorData) => void): void;
```

## �� 扩展点设计

### 1. 新增平台支持

```typescript
// 1. 实现 PlatformAdapter 接口
class NewPlatformAdapter implements PlatformAdapter {
  // ... 实现所有必需方法
}

// 2. 在 index.js 中添加环境检测
if (Environment.isNewPlatform()) {
  return loadNewPlatformSDK().init(config);
}
```

### 2. 新增监控类型

```typescript
// 1. 在 base.ts 中添加新类型
export enum NewMonitorType {
  NEW_TYPE = "new_type",
}

// 2. 在 PlatformAdapter 中添加新接口
interface NewMonitorAdapter {
  initNewMonitor(onData: (data: NewMonitorData) => void): void;
}
```

### 3. 自定义上报策略

```typescript
// 继承 BaseManager 重写上报逻辑
class CustomBaseManager extends BaseManager {
  protected async sendData(data: MonitorData[]): Promise<void> {
    // 自定义上报逻辑
  }
}
```

## 📊 性能与可靠性设计

### 1. 队列缓冲

- **目的**：避免频繁网络请求
- **实现**：`DataQueue` 类，支持批量发送
- **配置**：`maxQueueSize`、`batchSize`、`interval`

### 2. 错误重试

- **目的**：提高上报成功率
- **实现**：`RetryQueue` 类，指数退避策略
- **配置**：`maxRetries`、`retryDelay`

### 3. 离线缓存

- **目的**：网络异常时数据不丢失
- **实现**：`StorageAdapter` + 持久化存储
- **配置**：`enableOfflineCache`

### 4. 采样控制

- **目的**：控制数据量和性能影响
- **实现**：全局采样率 + 模块级采样率
- **配置**：`sampleRate`、`error.sampleRate`

## �� 调试与监控

### 1. 内置日志

```typescript
// 所有关键操作都有 console.log
console.log("[Monitor] SDK initialized successfully");
console.log("�� 错误被捕获:", errorData);
console.log("✅ 数据上报成功:", data);
```

### 2. 事件系统

```typescript
// 监听关键事件
monitor.on("error", (error) => console.log("错误发生:", error));
monitor.on("dataReported", (data) => console.log("数据上报:", data));
monitor.on("reportError", (error) => console.log("上报失败:", error));
```

### 3. 状态查询

```typescript
// 获取 SDK 运行状态
const status = monitor.getStatus();
console.log("队列大小:", status.queue.size);
console.log("错误数量:", status.queue.errorCount);
```

## 💡 快速理解要点

1. **分层设计**：入口层 → 适配层 → 管理层 → 接口层 → 工具层
2. **数据流向**：采集 → 入队 → 定时上报 → 网络发送
3. **扩展方式**：实现接口 + 环境检测 + 工厂创建
4. **核心价值**：跨平台统一 + 智能聚合 + 可靠上报

这个架构设计让你可以：

- 快速理解各模块职责
- 知道如何扩展新功能
- 明白数据如何流转
- 了解性能优化策略

需要我详细解释某个特定模块的设计思路吗？
